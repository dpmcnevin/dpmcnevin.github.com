<!DOCTYPE HTML>

<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="author" content="Your Name" />
    <title>Lost in Transaction</title>
    <link rel="stylesheet" type="text/css" href="css/source.css" />
  </head>
  <body>
    <header>
      <h1><a href="/">Random Rails</a></h1>
    </header>
    <section>
      <div class="content">
  <div id="post">
    <h1></h1>
    <div class="highlight"><pre><code class="ruby">  <span class="n">context</span> <span class="s2">&quot;don&#39;t allow duplicate issues&quot;</span> <span class="k">do</span>
    <span class="n">setup</span> <span class="k">do</span>
      <span class="vi">@issue</span> <span class="o">=</span> <span class="no">Issue</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;something&quot;</span><span class="p">,</span> <span class="ss">:start_at</span> <span class="o">=&gt;</span> <span class="s2">&quot;1/1/2010&quot;</span><span class="p">)</span>
    <span class="k">end</span>
    
    <span class="n">should</span> <span class="s2">&quot;not create a duplicate issue&quot;</span> <span class="k">do</span>
      <span class="n">assert_no_difference</span><span class="p">(</span><span class="s1">&#39;Issue.count&#39;</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">another_issue</span> <span class="o">=</span> <span class="no">Issue</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;something&quot;</span><span class="p">,</span> <span class="ss">:start_at</span> <span class="o">=&gt;</span> <span class="s2">&quot;1/1/2010&quot;</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
    
    <span class="n">should</span> <span class="s2">&quot;create a new issue if the duplicate issue is closed&quot;</span> <span class="k">do</span>
      <span class="vi">@issue</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="ss">:resolution</span> <span class="o">=&gt;</span> <span class="s2">&quot;something&quot;</span><span class="p">)</span>
      <span class="n">assert_difference</span><span class="p">(</span><span class="s1">&#39;Issue.count&#39;</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">another_issue</span> <span class="o">=</span> <span class="no">Issue</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;something&quot;</span><span class="p">,</span> <span class="ss">:start_at</span> <span class="o">=&gt;</span> <span class="s2">&quot;1/1/2010&quot;</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
    
    <span class="n">should</span> <span class="s2">&quot;add a comment on existing issue&quot;</span> <span class="k">do</span>
      <span class="n">assert_difference</span><span class="p">(</span><span class="s1">&#39;@issue.comments.count&#39;</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">another_issue</span> <span class="o">=</span> <span class="no">Issue</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;something&quot;</span><span class="p">,</span> <span class="ss">:start_at</span> <span class="o">=&gt;</span> <span class="s2">&quot;1/1/2010&quot;</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
</code></pre>
</div>


I am working on an issue tracking system at work. I built in an API so other systems can create events, but I wanted to make sure to minimize duplicate events, and opted to just add a comment in case the same issue was opened twice (or more.)<br /><br />I started with this test<br /><br /><script src="https://gist.github.com/661909.js?file=issue_test.rb"></script><br /><br />Then wrote this code:<br /><br /><script src="https://gist.github.com/661909.js?file=issue_before.rb"></script><br /><br />But it kept failing, which was weird to me, because it seemed right.. it wasn't until I tried it from the development&nbsp;environment&nbsp;and checked out the logs that I saw what was happening..<br /><br /><script src="https://gist.github.com/661909.js?file=development.log"></script><br /><br />The whole request was being wrapped in a transaction and being rolled back.. A little google searching later, I found <a href="http://api.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html">after_rollback</a>, and wrote a new callback<br /><br /><script src="https://gist.github.com/661909.js?file=issue_after.rb"></script><br /><br />And now everything is working as intended. So if you run into a similar situation, I hope that this will help out.<div class="blogger-post-footer"><img width='1' height='1' src='https://blogger.googleusercontent.com/tracker/7616842831210003750-1072726240741636397?l=random-rails.blogspot.com' alt='' /></div>

  </div>
</div>

    </section>
  </body>
</html>
